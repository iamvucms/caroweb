<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <title>
                Caro
            </title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js">
            </script>
        </meta>
    </head>
    <body>
        <center>
            <h1 style="color:blue;font-family: monospace;">
                Caro
            </h1>
            <h3 id="myinfo" style="font-family: monospace;">
            </h3>
            <h3 id="status" style="font-family: monospace;">
            </h3>
            <h3 id="mytime" style="font-family: monospace;">
            </h3>
        </center>
        <table id="caroTable" style="margin: 50px auto;">
        </table>
        <style type="text/css">
            td{
		height: 35px;
		width: 35px;
		display: inline-block;
		border: 0.2px solid green;
		margin: 0;
		margin-right: 2.5px; 
		text-align: center;
		line-height: 35px;
		font-family: monospace;
		font-size: 25px;
	}
	tr{
		margin: 0;
	}
        </style>
        <script type="text/javascript">
            var id_match;
        	var mytime;
        	var status = false;
            var type;
      var col = 20;
	var row = 20;
	rightTo = col-1;
	leftTo = col+1;
	for(i=1;i <=row;i++){
		$('#caroTable').append('<tr data-rowId='+i+'><tr>');
		var appendData ='';
		for(z=1;z<=col;z++){
			appendData +='<td data-id="'+((i-1)*col+z)+'"></td>';
		}
		$('tr[data-rowId="'+i+'"]').append(appendData);
	}

		var conn = new WebSocket("wss://node2.wsninja.io");
	conn.onopen = function(e) {
	    console.log("Kết nối server thành công!");
	    conn.send(JSON.stringify({ guid: "3d754fb2-2c80-4a57-b0d5-ee044524cec5" }));
	    var checkstt = setInterval(function(){ 
		if(id_match !=null){
			$.ajax({
			    	method: 'get',
			    	url: 'http://vucms.systems/caroweb/whoplay.php?id_match='+id_match,
			    	success: function(data){
			    		data = JSON.parse(data);
			    		 type = data.mytype;if(type=='x' && data.status=='success'){$('#mytime').html('<p style="color:green">Lượt chơi: Đến lượt bạn !</p>');mytime =true;}  else mytime =false;
			    		id_match = data.id_match;

			    		$('#myinfo').html('Bạn bên: '+type);
			    		if(data.status =='pending'){ $('#status').html('Trạng thái: Đang tìm đứa dở hơi nào đó chơi với bạn...');}
			    		else {$('#status').html('Trạng thái: <p style="color:green">Đã tìm thấy đứa dở hơi đánh với bạn !</p>');clearInterval(checkstt);}

			    	}
			    });
		}else{
			$.ajax({
			    	method: 'get',
			    	url: 'http://vucms.systems/caroweb/whoplay.php',
			    	success: function(data){
			    		data = JSON.parse(data);
			    		 type = data.mytype;if(type=='x' && data.status=='success'){$('#mytime').html('<p style="color:green">Lượt chơi: Đến lượt bạn !</p>');mytime =true;}  else mytime =false;
			    		id_match = data.id_match;
			    		$('#myinfo').html('Bạn bên: '+type);
			    		if(data.status =='pending'){ $('#status').html('Trạng thái: Đang tìm đứa dở hơi nào đó chơi với bạn...');}
			    		else {$('#status').html('Trạng thái: <p style="color:green">Đã tìm thấy đứa dở hơi đánh với bạn !</p>');clearInterval(checkstt);}

			    	}
			    });
		}

	     }, 1500);

	    
	};
	conn.onclose = function(x){

	}
	conn.onmessage = function(e){
		e = JSON.parse(e.data);
		if(id_match==e.id_match && e.yourtype != type){
		id = e.areaId;
		yourtype = e.yourtype;
		if(yourtype=='x' && $('td[data-id="'+id+'"]').html()=='' ){$('td[data-id="'+id+'"]').html('X');
		$('td[data-id="'+id+'"]').attr('data-xid','x');}
		if(yourtype=='o' && $('td[data-id="'+id+'"]').html()==''){$('td[data-id="'+id+'"]').html('O');
		$('td[data-id="'+id+'"]').attr('data-oid','o');}
		$('#mytime').html('<p style="color:green">Lượt chơi: Đến lượt bạn !</p>');
		mytime = true;

	}
	} 
	$('td').click(function(){
		if($('td[data-id="'+$(this).data('id')+'"]').html()=='X' || $('td[data-id="'+$(this).data('id')+'"]').html()=='O' ) return false;
		if(mytime==true){

			id = $(this).data('id');
		if(type=='x' && $('td[data-id="'+id+'"]').html()=='' ){$('td[data-id="'+id+'"]').html('X');
		$('td[data-id="'+id+'"]').attr('data-xid','x');} 
		if(type=='o' && $('td[data-id="'+id+'"]').html()==''){$('td[data-id="'+id+'"]').html('O');
		$('td[data-id="'+id+'"]').attr('data-oid','o');}
		$('#mytime').html('<p style="color:black">Lượt chơi: Đến lượt người kia !</p>');
		conn.send(JSON.stringify({yourtype:type,areaId:id,id_match:id_match}));
		mytime = false;
		var id =[];
		$('td[data-'+type+'id="'+type+'"]').each(function(){
			id.push($(this).data('id'));

		});
		var successline =  [];
		for(i=0;i<id.length;i++){
					dataid = id[i];
					successline.push(dataid);
					for(z=1;z<5;z++){
						if($.inArray(dataid+z,id) >=0){
							successline.push(dataid+z);
						}
						if(z==4 && successline.length < 5) successline =[]; 
					}
				// 	if(successline.length < 5) {successline =[];
				// 	for(z=col;z<col*5;z+=col){
				// 		if($.inArray(dataid+z,id) >=0){
				// 			console.log(dataid+z);
				// 			successline.push(dataid+z);
				// 		}
						
				// 	}
				// }
				// 	if(successline.length < 5){ successline =[];
				// 	for(z=rightTo;z<rightTo*5;z+=rightTo){
				// 		if($.inArray(dataid+z,id) >=0){
				// 			successline.push(dataid+z);
				// 		}
						
				// 	}}
				// 	if(successline.length < 5){successline =[];
				// 	for(z=leftTo;z<leftTo*5;z+=leftTo){
				// 		if($.inArray(dataid+z,id) >=0){
				// 			successline.push(dataid+z);
				// 		}
						
				// 	}} 
				// 	if(successline.length < 5) successline =[];
					
					


			

			}
			console.log(successline);
		}
		
	});
        </script>
    </body>
</html>